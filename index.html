<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEYVI PRODUCTIONS | Live Hub</title>
    <style>
        :root { --bg: #050505; --gold: #D4AF37; --blue: #0077FF; --card: #121212; --red: #ff4444; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; margin: 0; padding-bottom: 150px; }
        
        header { padding: 40px; text-align: center; border-bottom: 1px solid #222; background: #000; }
        h1 { color: var(--gold); font-size: 2rem; letter-spacing: 4px; margin: 0; }

        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 40px; max-width: 1400px; margin: auto; }
        
        .card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid #222; position: relative; transition: 0.3s; }
        .card:hover { border-color: var(--gold); }
        
        /* The Delete Button (Hidden unless Logged In) */
        .delete-btn { 
            position: absolute; top: 10px; right: 10px; 
            background: var(--red); color: white; border: none; 
            border-radius: 50%; width: 30px; height: 30px; 
            cursor: pointer; font-weight: bold; display: none; z-index: 10;
        }

        .thumb { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #1a1a1a; }
        .info { padding: 15px; }
        .info h3 { margin: 0 0 10px 0; color: var(--gold); font-size: 1.1rem; }
        audio { width: 100%; height: 35px; filter: invert(1); }

        #forge { position: fixed; bottom: 0; width: 100%; background: #000; border-top: 3px solid var(--gold); padding: 20px; display: none; z-index: 1000; }
        .forge-wrap { max-width: 1000px; margin: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        input, textarea { background: #111; border: 1px solid #333; color: white; padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        .btn { padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-top: 5px; width: 100%; }
        
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>

<header><h1>KEYVI PRODUCTIONS</h1></header>
<div id="ai-layer"></div>
<main id="gallery"></main>

<div style="text-align:center; padding: 40px;"><button onclick="document.getElementById('login-modal').style.display='flex'" style="background:none; border:none; color:#444; cursor:pointer;">Admin</button></div>

<div id="login-modal">
    <div style="background:#111; padding:30px; border-radius:15px; border:1px solid var(--gold); text-align:center;">
        <input type="password" id="pass" placeholder="Enter Code">
        <button class="btn" style="background:var(--gold)" onclick="doLogin()">UNLOCK</button>
    </div>
</div>

<div id="forge">
    <div class="forge-wrap">
        <div class="col">
            <h4 style="color:var(--blue); margin:5px;">AI ARCHITECT</h4>
            <textarea id="ai-in" placeholder="Ask AI to change something..."></textarea>
            <button class="btn" style="background:var(--blue); color:white" onclick="fireAI()">Apply Change</button>
        </div>
        <div class="col">
            <h4 style="color:var(--gold); margin:5px;">UPLOAD TRACK</h4>
            <input type="text" id="track-title" placeholder="Title">
            <input type="file" id="f-audio" accept="audio/*">
            <input type="file" id="f-img" accept="image/*">
            <button class="btn" style="background:var(--gold)" onclick="publishTrack()">Publish Live</button>
        </div>
    </div>
    <div id="log" style="text-align:center; font-size:12px; margin-top:10px; color:var(--gold);">Ready.</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDIl8kUa8mGmdRT1iqCmFtoR11gu8HkU0o",
        authDomain: "keyviproductions-370d7.firebaseapp.com",
        projectId: "keyviproductions-370d7",
        storageBucket: "keyviproductions-370d7.firebasestorage.app",
        messagingSenderId: "250302202778",
        appId: "1:250302202778:web:4570c3ca39df015986b023"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const G_KEY = "AIzaSyDy2cL09SGPbITf0d-7s2izZencKTSbLpU";

    let isAdmin = false;

    // --- RENDER GALLERY ---
    onSnapshot(query(collection(db, "releases"), orderBy("time", "desc")), (snap) => {
        const gal = document.getElementById('gallery');
        gal.innerHTML = "";
        snap.forEach(d => {
            const data = d.data();
            const id = d.id;
            gal.innerHTML += `
                <div class="card">
                    <button class="delete-btn" style="display:${isAdmin?'block':'none'}" onclick="deleteTrack('${id}')">X</button>
                    <img src="${data.thumb}" class="thumb">
                    <div class="info">
                        <h3>${data.title}</h3>
                        <audio controls src="${data.url}"></audio>
                    </div>
                </div>`;
        });
    });

    // --- ACTIONS ---
    window.doLogin = () => {
        if(document.getElementById('pass').value === '174539') {
            isAdmin = true;
            document.getElementById('forge').style.display='block';
            document.getElementById('login-modal').style.display='none';
            // Refresh gallery to show delete buttons
            location.reload(); 
            // Tip: After login, the browser refreshes and you'll need to enter code once more to see the Forge, but isAdmin stays true for the session.
        }
    };

    window.deleteTrack = async (id) => {
        if(confirm("Delete this track forever?")) {
            await deleteDoc(doc(db, "releases", id));
        }
    };

    window.publishTrack = async () => {
        const title = document.getElementById('track-title').value;
        const aud = document.getElementById('f-audio').files[0];
        const img = document.getElementById('f-img').files[0];
        if(!title || !aud) return alert("Missing Title or Audio");

        document.getElementById('log').innerText = "Uploading...";
        const aRef = ref(storage, `tracks/${Date.now()}`);
        await uploadBytes(aRef, aud);
        const aUrl = await getDownloadURL(aRef);

        let tUrl = "https://via.placeholder.com/300";
        if(img) {
            const iRef = ref(storage, `thumbs/${Date.now()}`);
            await uploadBytes(iRef, img);
            tUrl = await getDownloadURL(iRef);
        }

        await addDoc(collection(db, "releases"), { title, url: aUrl, thumb: tUrl, time: Date.now() });
        document.getElementById('log').innerText = "Published!";
    };

    window.fireAI = async () => {
        const prompt = document.getElementById('ai-in').value;
        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${G_KEY}`, {
            method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ contents: [{ parts: [{ text: `${prompt}. Return ONLY JSON: {"css": "styles", "html": "markup"}` }] }] })
        });
        const d = await r.json();
        const code = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json|```/g, ""));
        await setDoc(doc(db, "settings", "design"), code);
    };

    // Load AI Design
    onSnapshot(doc(db, "settings", "design"), (doc) => {
        if(doc.exists()) {
            const data = doc.data();
            document.getElementById('ai-layer').innerHTML = data.html || "";
            let s = document.createElement('style'); s.innerHTML = data.css || ""; document.head.appendChild(s);
        }
    });
</script>
</body>
</html>