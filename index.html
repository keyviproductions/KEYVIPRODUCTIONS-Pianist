<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEYVI PRODUCTIONS | Official</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;700&display=swap" rel="stylesheet">
    <style id="base-styles">
        :root { --gold: #D4AF37; --bg: #000; }
        body { background: var(--bg); color: white; font-family: 'Montserrat', sans-serif; margin: 0; }
        .hero { height: 60vh; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; border-bottom: 2px solid var(--gold); background: #111; }
        nav { background: rgba(0,0,0,0.9); padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; }
        nav a { color: white; text-decoration: none; margin: 0 15px; font-weight: bold; font-size: 0.8rem; }
        #gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 40px; }
        .card { background: #111; border: 1px solid #222; position: relative; padding-bottom: 15px; }
        .thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        audio { width: 90%; margin: 5%; filter: invert(1); }
        #admin-forge { position: fixed; bottom: 0; width: 100%; background: #000; border-top: 3px solid var(--gold); padding: 20px; display: none; z-index: 999; box-shadow: 0 -10px 30px rgba(0,0,0,1); }
        .forge-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1200px; margin: auto; }
        input, textarea { background: #111; border: 1px solid #444; color: white; padding: 10px; width: 100%; margin-bottom: 10px; border-radius: 5px; box-sizing: border-box; }
        .btn { padding: 12px; background: var(--gold); color: black; border: none; font-weight: bold; cursor: pointer; width: 100%; text-transform: uppercase; }
        #login-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 9999; }
    </style>
    <style id="ai-styles"></style>
</head>
<body>

<div id="ai-content-top"></div>

<section class="hero">
    <h1 id="site-title">KEYVI PRODUCTIONS</h1>
    <p id="site-slogan">PIANIST â€¢ PRODUCER</p>
</section>

<nav id="site-nav">
    <a href="#music">MUSIC</a>
    <a href="#" id="yt-link">YOUTUBE</a>
    <a href="#" id="contact-link">CONTACT</a>
</nav>

<main id="gallery"></main>

<div id="ai-content-bottom"></div>

<footer style="text-align:center; padding: 40px; border-top: 1px solid #222;">
    <p id="footer-text">&copy; 2025 KEYVI PRODUCTIONS</p>
    <button onclick="document.getElementById('login-modal').style.display='flex'" style="opacity:0.1; background:none; color:white; border:none; cursor:pointer;">Admin</button>
</footer>

<div id="login-modal">
    <div style="background:#111; padding:30px; border-radius:10px; border:1px solid var(--gold); text-align:center;">
        <h3>ADMIN ACCESS</h3>
        <input type="password" id="pass" placeholder="Passcode">
        <button class="btn" onclick="doLogin()">Unlock Forge</button>
    </div>
</div>

<div id="admin-forge">
    <div class="forge-grid">
        <div>
            <h4 style="color:var(--gold)">AI ARCHITECT (Real-Time Styling)</h4>
            <textarea id="ai-prompt" rows="4" placeholder="Example: Change the title to 'Piano King', make the background dark blue, and set the YouTube link to https://youtube.com/..."></textarea>
            <button class="btn" onclick="fireAI()">Apply All Changes</button>
        </div>
        <div>
            <h4 style="color:var(--gold)">MUSIC UPLOADER</h4>
            <input type="text" id="t-title" placeholder="Track Name">
            <label style="font-size:10px">Audio File:</label>
            <input type="file" id="f-aud" accept="audio/*">
            <label style="font-size:10px">Cover Image:</label>
            <input type="file" id="f-img" accept="image/*">
            <button class="btn" onclick="publish()">Publish Track</button>
        </div>
    </div>
    <div id="status" style="text-align:center; color:var(--gold); font-size:12px; margin-top:10px;">System Ready</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDIl8kUa8mGmdRT1iqCmFtoR11gu8HkU0o",
        authDomain: "keyviproductions-370d7.firebaseapp.com",
        projectId: "keyviproductions-370d7",
        storageBucket: "keyviproductions-370d7.firebasestorage.app",
        messagingSenderId: "250302202778",
        appId: "1:250302202778:web:4570c3ca39df015986b023"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const G_KEY = "AIzaSyDy2cL09SGPbITf0d-7s2izZencKTSbLpU";

    let isAdmin = false;

    // 1. LOGIN
    window.doLogin = () => {
        if(document.getElementById('pass').value === '174539') {
            isAdmin = true;
            document.getElementById('admin-forge').style.display = 'block';
            document.getElementById('login-modal').style.display = 'none';
        }
    };

    // 2. REAL-TIME AI STYLING & LINKS
    window.fireAI = async () => {
        const prompt = document.getElementById('ai-prompt').value;
        const status = document.getElementById('status');
        status.innerText = "Gemini is analyzing and rewriting...";

        const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${G_KEY}`, {
            method: "POST", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ contents: [{ parts: [{ text: `Task: ${prompt}. You must return a JSON object that controls the site. Format: {"css": "all new css styles", "top_html": "extra html for top", "bottom_html": "extra html for bottom", "title": "new site name", "slogan": "new slogan", "yt": "youtube url", "contact": "email or phone"}. Return ONLY JSON.` }] }] })
        });
        
        const d = await r.json();
        const code = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json|```/g, ""));
        
        // Save to Firebase - This makes the change permanent for everyone
        await setDoc(doc(db, "settings", "global_config"), code);
        status.innerText = "Site successfully customized!";
    };

    // Listen for Site Changes
    onSnapshot(doc(db, "settings", "global_config"), (snap) => {
        if(snap.exists()) {
            const data = snap.data();
            if(data.css) document.getElementById('ai-styles').innerHTML = data.css;
            if(data.top_html) document.getElementById('ai-content-top').innerHTML = data.top_html;
            if(data.bottom_html) document.getElementById('ai-content-bottom').innerHTML = data.bottom_html;
            if(data.title) document.getElementById('site-title').innerText = data.title;
            if(data.slogan) document.getElementById('site-slogan').innerText = data.slogan;
            if(data.yt) document.getElementById('yt-link').href = data.yt;
            if(data.contact) document.getElementById('contact-link').href = "mailto:" + data.contact;
        }
    });

    // 3. REAL-TIME MUSIC UPLOAD
    window.publish = async () => {
        const title = document.getElementById('t-title').value;
        const aud = document.getElementById('f-aud').files[0];
        const img = document.getElementById('f-img').files[0];
        const status = document.getElementById('status');
        if(!title || !aud) return alert("Title and Audio file required!");

        status.innerText = "Uploading Audio...";
        const aRef = ref(storage, `music/${Date.now()}`);
        await uploadBytes(aRef, aud);
        const aUrl = await getDownloadURL(aRef);

        let tUrl = "https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?w=400";
        if(img) {
            status.innerText = "Uploading Image...";
            const iRef = ref(storage, `thumbs/${Date.now()}`);
            await uploadBytes(iRef, img);
            tUrl = await getDownloadURL(iRef);
        }

        await addDoc(collection(db, "releases"), { title, url: aUrl, thumb: tUrl, time: Date.now() });
        status.innerText = "Track Published!";
        document.getElementById('t-title').value = "";
    };

    // 4. REAL-TIME GALLERY LISTENER
    onSnapshot(query(collection(db, "releases"), orderBy("time", "desc")), (snap) => {
        const gal = document.getElementById('gallery');
        gal.innerHTML = "";
        snap.forEach(d => {
            const item = d.data();
            const id = d.id;
            const card = document.createElement('div');
            card.className = "card";
            card.innerHTML = `
                <button onclick="del('${id}')" style="display:${isAdmin?'block':'none'}; position:absolute; top:5px; right:5px; background:red; color:white; border:none; cursor:pointer;">X</button>
                <img src="${item.thumb}" class="thumb">
                <div style="padding:15px; text-align:center;">
                    <h3 style="margin:0; color:var(--gold);">${item.title}</h3>
                    <audio controls src="${item.url}"></audio>
                </div>`;
            gal.appendChild(card);
        });
    });

    window.del = async (id) => { if(confirm("Delete this?")) await deleteDoc(doc(db, "releases", id)); };
</script>
</body>
</html>